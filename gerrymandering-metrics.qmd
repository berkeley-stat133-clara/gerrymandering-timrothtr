---
title: Gerrymandering Metrics
format: typst
---

### 2024 Election Results and the 2024 District Map

```{r}
library(tidyverse)
library(scales)
precinct_long <- read_csv("data/precinct_clean_long.csv")


# Filter to Congressional races only 
congress <- precinct_long |>
  filter(race_type == "Congress") |>
  group_by(district, candidate_party) |>
  summarise(total_votes = sum(votes, na.rm = TRUE), .groups = "drop") |>
  pivot_wider(names_from = candidate_party, values_from = total_votes, values_fill = 0) |>
  mutate(
    total = DEM + REP,
    dem_share = DEM / total
  ) |>
  filter(total > 0)  # exclude empty districts

# Mean–Median Difference
mean_share <- mean(congress$dem_share, na.rm = TRUE)
median_share <- median(congress$dem_share, na.rm = TRUE)
mm_diff <- mean_share - median_share

cat("Mean Democratic vote share:", round(mean_share, 3), "\n")
cat("Median Democratic vote share:", round(median_share, 3), "\n")
cat("Mean–Median Difference:", round(mm_diff, 3), "\n")

# Efficiency Gap
# Define wasted votes
congress <- congress |>
  mutate(
    dem_wasted = if_else(DEM > REP, DEM - (total / 2), DEM),
    rep_wasted = if_else(REP > DEM, REP - (total / 2), REP)
  )

total_dem_wasted <- sum(congress$dem_wasted, na.rm = TRUE)
total_rep_wasted <- sum(congress$rep_wasted, na.rm = TRUE)
total_votes <- sum(congress$total, na.rm = TRUE)

efficiency_gap <- (total_rep_wasted - total_dem_wasted) / total_votes

cat("Efficiency Gap:", round(efficiency_gap, 3), "\n")

# Visualization of Democratic vote shares
ggplot(congress, aes(x = dem_share)) +
  geom_histogram(bins = 20, fill = "#2E74C0", color = "white", alpha = 0.85) +
  geom_vline(xintercept = mean_share, linetype = "dashed", color = "red", linewidth = 0.8) +
  geom_vline(xintercept = median_share, linetype = "dotted", color = "darkred", linewidth = 0.8) +
  annotate("text", x = 0.8, y = 10, 
           label = paste0("EG = ", round(efficiency_gap, 3)), 
           hjust = 0, size = 4.5, color = "gray20") +
  scale_x_continuous(labels = scales::percent_format(accuracy = 1)) +
  labs(
    title = "Distribution of Democratic Vote Share by Congressional District",
    subtitle = paste0("Mean–Median Difference = ", round(mm_diff, 3)),
    x = "Democratic Share of Votes",
    y = "Number of Districts"
  ) +
  theme_minimal(base_size = 13)
```


### 2024 Election Results and the proposed 2025 District Map
```{r}
library(sf)

sr_geo <- st_read("data/shapefiles/srprecinct_cleaned.shp")
ab604_shp <- st_read("data/shapefiles/ab604_cleaned.shp")
votes_sr <- read_csv("data/srprecinct_votes_cleaned.csv")
```

```{r}
# Step 1: Create total DEM and REP votes across all races (convert to numeric first)
votes_sr <- votes_sr |>
  mutate(across(matches("dem|rep", ignore.case = TRUE), ~ suppressWarnings(as.numeric(.)))) |>
  mutate(
    DEM = rowSums(across(matches("dem", ignore.case = TRUE)), na.rm = TRUE),
    REP = rowSums(across(matches("rep", ignore.case = TRUE)), na.rm = TRUE),
    total = DEM + REP
  )

# Step 2: Ensure valid geometry and matching CRS
sr_geo <- st_make_valid(sr_geo) |> st_transform(3310)
ab604_shp <- st_make_valid(ab604_shp) |> st_transform(3310)

# Step 3: Attach the total DEM/REP vote data to the SR precinct geometry
# (we join the votes_sr table to sr_geo by precinct key — likely "srprec" or "srprec_key")
sr_geo <- sr_geo |>
  left_join(votes_sr, by = "srprec")   # check the column name in votes_sr (srprec or srprec_key)

# Step 4: Join to new AB604 districts
votes_ab604 <- st_join(sr_geo, ab604_shp, join = st_intersects, left = TRUE)

```

```{r}
# Step 5: Aggregate by district
district_results_ab604 <- votes_ab604 |>
  st_drop_geometry() |>
  group_by(DISTRICT) |>
  summarise(
    DEM = sum(DEM, na.rm = TRUE),
    REP = sum(REP, na.rm = TRUE),
    total = sum(total, na.rm = TRUE),
    .groups = "drop"
  ) |>
  mutate(
    dem_share = DEM / (DEM + REP)
  )

# Step 6: Compute metrics
mm_diff_ab604 <- mean(district_results_ab604$dem_share, na.rm = TRUE) -
                 median(district_results_ab604$dem_share, na.rm = TRUE)

district_results_ab604 <- district_results_ab604 |>
  mutate(
    dem_wasted = if_else(DEM > REP, DEM - (total / 2), DEM),
    rep_wasted = if_else(REP > DEM, REP - (total / 2), REP)
  )

eff_gap_ab604 <- (sum(district_results_ab604$dem_wasted) -
                  sum(district_results_ab604$rep_wasted)) /
                  sum(district_results_ab604$total)

# Step 7: Print results
cat("Mean–Median Difference (AB604): ", round(mm_diff_ab604, 3), "\n")
cat("Efficiency Gap (AB604): ", round(eff_gap_ab604, 3), "\n")
```

```{r}
# Visualization: Democratic Vote Share Distribution (AB604 Map)

ggplot(district_results_ab604, aes(x = dem_share)) +
  geom_histogram(bins = 20, fill = "#2E74C0", color = "white", alpha = 0.85) +
  geom_vline(xintercept = mean(district_results_ab604$dem_share, na.rm = TRUE),
             linetype = "dashed", color = "red", linewidth = 0.8) +
  geom_vline(xintercept = median(district_results_ab604$dem_share, na.rm = TRUE),
             linetype = "dotted", color = "darkred", linewidth = 0.8) +
  annotate("text", x = 0.8, y = 10, 
           label = paste("EG =", round(eff_gap_ab604, 3)),
           hjust = 0, size = 4.5, color = "gray20") +
  scale_x_continuous(labels = scales::percent_format(accuracy = 1)) +
  labs(
    title = "Distribution of Democratic Vote Share by Congressional District (AB604 Proposed Map)",
    subtitle = paste("Mean–Median Difference =", round(mm_diff_ab604, 3)),
    x = "Democratic Share of Votes",
    y = "Number of Districts"
  ) +
  theme_minimal(base_size = 13)
```









